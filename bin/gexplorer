#!/usr/bin/env python
import os
from argparse import ArgumentParser

import logging
import waitress

from indexclient.client import IndexClient

import explorer


def parse_args():

    parser = ArgumentParser(description="Graph Explorer script")
    parser.add_argument("-p", "--port",
                        help="HTTP port to listen on", required=False, type=int, default=19891)

    subparser = parser.add_subparsers()

    # starts services
    start = subparser.add_parser("start", help="Start the server")
    start.add_argument("-t", "--threads",
                       help="thread pool size",
                       default=10, type=int)
    start.set_defaults(action="start")
    return parser.parse_args()


def get_index_client():
    return IndexClient(baseurl=os.environ.get("INDEXD_URL", "http://indexd.service.consul/"),
                       auth=(os.environ.get("INDEXD_USER"), os.environ.get("INDEXD_PWD")))


def main():

    logger = logging.getLogger('waitress')
    logger.setLevel(logging.INFO)

    args = parse_args()

    action = args.action
    if action == "start":
        app = explorer.make_app()
        waitress.serve(app, host="0.0.0.0", port=args.port)
    else:
        raise NotImplementedError("Unsupported command {}", action)


if __name__ == '__main__':
    main()
