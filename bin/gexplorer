#!/usr/bin/env python
from argparse import ArgumentParser

import cherrypy
from indexclient.client import IndexClient

from explorer import settings
from explorer.env import env
from explorer.graph.search import GSearch
from explorer.routes import IndexResource, GraphResource


def parse_args():

    parser = ArgumentParser(description="Graph Explorer script")
    parser.add_argument("-p", "--port",
                        help="HTTP port to listen on", required=False)

    subparser = parser.add_subparsers()

    # starts services
    start = subparser.add_parser("start", help="Start the server")
    start.add_argument("-t", "--threads",
                       help="thread pool size",
                       default=10, type=int)
    start.set_defaults(action="start")
    return parser.parse_args()


def get_index_client():
    return IndexClient(baseurl=env.get("INDEXD_URL", "http://indexd.service.consul/"),
                       auth=(env.get("INDEXD_USER"), env.get("INDEXD_PWD")))


def main():
    args = parse_args()
    settings.set_globals(args.port, args.threads)

    action = args.action
    if action == "start":
        gs = GSearch()
        cherrypy.tree.mount(IndexResource(), "/", config=settings.index)
        cherrypy.quickstart(GraphResource(gs, get_index_client()), "/s", config=settings.graph)
    else:
        raise NotImplementedError("Unsupported command {}", action)


if __name__ == '__main__':
    cherrypy.config.update(settings.globals)
    main()
